# 4. ìš´ì˜ì²´ì œ ëª…ë ¹ì–´ ì‹¤í–‰ (OS Command Injection)

## 1. ê°œìš” (Overview)
- **ì •ì˜**: ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì™¸ë¶€ ì…ë ¥ê°’ì„ ê²€ì¦í•˜ì§€ ì•Šê³  ì‹œìŠ¤í…œ ì‰˜(Shell) ëª…ë ¹ì–´ì˜ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•  ë•Œ ë°œìƒí•˜ëŠ” ì·¨ì•½ì .
- **ìœ„í—˜ë„**: **ìƒ (High)** / ì‹œìŠ¤í…œ ì¥ì•… ê°€ëŠ¥ (RCE: Remote Code Execution).
- **ë°œìƒ ì›ë¦¬**: ê³µê²©ìê°€ **ë©”íƒ€ ë¬¸ì(Meta Character)**ë¥¼ ì´ìš©í•˜ì—¬ ê¸°ì¡´ ëª…ë ¹ì–´ë¥¼ ì¢…ë£Œí•˜ê±°ë‚˜ ì—°ê²°í•˜ê³ , ì•…ì˜ì ì¸ ì‹œìŠ¤í…œ ëª…ë ¹ì–´ë¥¼ ì£¼ì…í•¨.

> **ğŸ’¡ ì£¼ìš” ë©”íƒ€ ë¬¸ì**
> - `;` (ëª…ë ¹ì–´ êµ¬ë¶„ì)
> - `&`, `&&` (ë°±ê·¸ë¼ìš´ë“œ ì‹¤í–‰, ë…¼ë¦¬ ì—°ì‚°ì)
> - `|`, `||` (íŒŒì´í”„, ë…¼ë¦¬ ì—°ì‚°ì)
> - `$()` , `` ` `` (ëª…ë ¹ì–´ ì¹˜í™˜)

---

## 2. ê³µê²© ë©”ì»¤ë‹ˆì¦˜ (Attack Vector)

### ì‹œë‚˜ë¦¬ì˜¤: Ping í…ŒìŠ¤íŠ¸ ê¸°ëŠ¥
ì‚¬ìš©ìë¡œë¶€í„° IPë¥¼ ì…ë ¥ë°›ì•„ `ping`ì„ ë‚ ë¦¬ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤ê³  ê°€ì •.

1. **ì •ìƒ ìš”ì²­**
   - ì…ë ¥ê°’: `8.8.8.8`
   - ì„œë²„ ì‹¤í–‰: `ping 8.8.8.8`

2. **ê³µê²© ìš”ì²­**
   - ì…ë ¥ê°’: `8.8.8.8; cat /etc/passwd`
   - ì„œë²„ ì‹¤í–‰:
     ```bash
     ping 8.8.8.8      # 1. í•‘ ì‹¤í–‰ë¨
     ;                 # 2. ëª…ë ¹ì–´ êµ¬ë¶„
     cat /etc/passwd   # 3. íŒ¨ìŠ¤ì›Œë“œ íŒŒì¼ ì—´ëŒ ì‹¤í–‰ë¨ (ì •ë³´ ìœ ì¶œ)
     ```

---

## 3. ì·¨ì•½í•œ ì½”ë“œ vs ì•ˆì „í•œ ì½”ë“œ (Java)

### âŒ ì·¨ì•½í•œ ì½”ë“œ (Vulnerable)
> `Runtime.exec`ì— ì…ë ¥ê°’ì„ ë¬¸ìì—´ ê²°í•©(+)ìœ¼ë¡œ ì „ë‹¬í•˜ì—¬ ì‰˜ì´ ê°œì…í•  ì—¬ì§€ë¥¼ ì¤Œ.

```java
public void pingTest(String ip) {
    try {
        // ì…ë ¥ê°’ ê²€ì¦ ì—†ìŒ
        String cmd = "ping -c 3 " + ip;
        
        // ì‰˜ì´ ë©”íƒ€ ë¬¸ìë¥¼ í•´ì„í•˜ì—¬ ë‹¤ì¤‘ ëª…ë ¹ì–´ ì‹¤í–‰ ê°€ëŠ¥
        Process p = Runtime.getRuntime().exec(cmd);
        
    } catch (Exception e) {
        e.printStackTrace();
    }
}
```
### âœ… ì•ˆì „í•œ ì½”ë“œ (Secure Coding)
> **í•µì‹¬ ì „ëµ 2ê°€ì§€ ì ìš©**
> 1. **White-List ê²€ì¦**: ì •ê·œì‹ì„ í†µí•´ í—ˆìš©ëœ í¬ë§·(IP)ì¸ì§€ í™•ì¸.
> 2. **ProcessBuilder ì‚¬ìš©**: ëª…ë ¹ì–´ì™€ ì¸ì(Argument)ë¥¼ ë¶„ë¦¬í•˜ì—¬ ì‰˜ í•´ì„ ë°©ì§€.

```java
public void pingTestSecure(String ip) {
    // [Step 1] ì…ë ¥ê°’ ê²€ì¦ (White-list)
    // IPv4 í˜•ì‹ì´ ë§ëŠ”ì§€ ì •ê·œì‹ìœ¼ë¡œ ì²´í¬
    String regex = "^\\d{1,3}(\\.\\d{1,3}){3}$";
    if (!ip.matches(regex)) {
        throw new SecurityException("ìœ íš¨í•˜ì§€ ì•Šì€ IP í˜•ì‹ì…ë‹ˆë‹¤.");
    }

    try {
        // [Step 2] ProcessBuilderë¥¼ í†µí•œ ì¸ì ë¶„ë¦¬
        // ì‰˜ì„ ê±°ì¹˜ì§€ ì•Šê³  ì‹¤í–‰ íŒŒì¼ì— ì¸ìë§Œ ì „ë‹¬ë¨
        List<String> commands = new ArrayList<>();
        commands.add("ping");
        commands.add("-c");
        commands.add("3");
        commands.add(ip); // ì—¬ê¸°ì— "; cat"ì´ ë“¤ì–´ì™€ë„ ë‹¨ìˆœ ë¬¸ìì—´ë¡œ ì¸ì‹ë¨

        ProcessBuilder pb = new ProcessBuilder(commands);
        Process p = pb.start();
        
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```
### Process Builder?
>ìë°”(Java)ì—ì„œ ì™¸ë¶€ í”„ë¡œì„¸ìŠ¤(ìš´ì˜ì²´ì œ ëª…ë ¹ì–´, ì‰˜ ìŠ¤í¬ë¦½íŠ¸ ë“±)ë¥¼ ìƒì„±í•˜ê³  ì œì–´í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë˜ëŠ” í´ë˜ìŠ¤

Runtime.exec -> ProcessBuilder ë¥¼ ì´ìš©í•œ inputì˜ ë¬¸ìì—´ì²˜ë¦¬ê°€ ì¤‘ìš”í•¨.
ì…ë ¥ê°’ì— ëŒ€í•œ ì •ê·œì‹ í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ê²€ì¦ì„ ì„ í–‰í•˜ê³ , ëª…ë ¹ì–´ì™€ ì¸ìë¥¼ êµ¬ì¡°ì ìœ¼ë¡œ ë¶„ë¦¬.

---
### ì˜ˆìƒì§ˆë¬¸
>1. Process Builderê°€ Runtime.exec ë³´ë‹¤ ì•ˆì „í•œ ê¸°ìˆ ì¸ ì´ìœ 

ê°€ì¥ í° ì°¨ì´ëŠ” ì‰˜ì˜ ê°œì… ìœ ë¬´ë‹¤. ë‹¤ìŒì€ ì¸ì(Argument) íŒŒì‹±ì²˜ë¦¬ì´ë‹¤.
ê¸°ì¡´ Runtime.exec ë°©ì‹ì€ ì…ë ¥ëœ ë¬¸ìì—´ì„ ë¶ˆì™„ì „í•˜ê²Œ íŒŒì‹±í•˜ê¸° ë•Œë¬¸ì—, ê³µê²©ìê°€ ;(ì„¸ë¯¸ì½œë¡ ) ê³¼ ê°™ì€ ë©”íƒ€ë¬¸ìë¥¼ ì£¼ì…í•˜ë©´ ì‰˜ì´ ì´ë¥¼ ëª…ë ¹ì–´ë¡œ í•´ì„í•˜ì—¬ ì‹¤í–‰í•˜ëŠ” êµ¬ì¡°ì  ì·¨ì•½ì ì´ ì¡´ì¬í•œë‹¤.

í•˜ì§€ë§Œ Process Builder ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ì¸ìë¥¼ List í˜•íƒœë¡œ ëª…í™•íˆ ë¶„ë¦¬í•˜ì—¬ OS ì»¤ë„ì— ì§ì ‘ ì „ë‹¬í•œë‹¤. ì´ ê³¼ì •ì—ì„œ ì‰˜ì— ì „ë‹¬í•  ë¿ ì‚¬ìš©ìê°€ ì§ì ‘ ì‰˜ì— ëª…ë ¹ì–´ë¥¼ ì „ë‹¬í•  ìˆ˜ ì—†ìœ¼ë©°, ì‚¬ìš©ìì˜ ì…ë ¥ êµ¬ë¬¸ì€ ë‹¨ìˆœ ë¬¸ìì—´ë¡œ ì²˜ë¦¬ëœë‹¤. ë©”íƒ€ ë¬¸ìë¥¼ í¬í•¨ì‹œì¼œ ì…ë ¥ êµ¬ë¬¸ì„ ì¡°ì‘í•˜ë”ë¼ë„ ì˜¤ë¥˜ê°€ ë‚  ë¿ ì‹¤í–‰ë˜ì–´ì§€ì§€ ì•ŠëŠ”ë‹¤. 

>2. Process Builderë¥¼ ì‚¬ìš©í•˜ë©´ 100% ì•ˆì „í•œê°€ìš”?

ì•„ë‹ˆë‹¤. Process Builderë¥¼ ì´ìš©í•˜ë”ë¼ë„, sh ë‚˜ cmdì— ì§ì ‘ ì „ë‹¬í•˜ê²Œ ë˜ë©´ ë©”íƒ€ ë¬¸ìë¥¼ í¬í•¨ì‹œì¼œì„œ ì¡°ì‘ì´ ê°€ëŠ¥í•˜ë‹¤. ê·¸ëŸ¬ë¯€ë¡œ, ì‰˜ ì§ì ‘ í˜¸ì¶œì´ ì•„ë‹Œ ì‚¬ìš©í•´ì•¼ë§Œ í•˜ëŠ” ëª…ë ¹ì–´ë¥¼ íŠ¹ì •í•˜ì—¬ ì½”ë”©í•˜ëŠ”ê²Œ ì¤‘ìš”í•˜ë‹¤.

```java
// ì‰˜ì„ ì§ì ‘ í˜¸ì¶œí•˜ê³ , ì‚¬ìš©ì ì…ë ¥(input)ì„ í†µì§¸ë¡œ ë„˜ê¸°ë©´ ì•ˆ ë¨!
ProcessBuilder pb = new ProcessBuilder("sh", "-c", "ping " + input);
// inputì— "; ls"ê°€ ë“¤ì–´ì˜¤ë©´ ì‰˜ì´ í•´ì„í•´ì„œ ì‹¤í–‰ë¨.

// ì‰˜ì„ ë¶€ë¥´ì§€ ì•Šê³ , ì‹¤í–‰ íŒŒì¼(ping)ì„ ì§ì ‘ ë¶€ë¥´ê³  ì¸ìë¥¼ ë”°ë¡œ ì¤Œ
ProcessBuilder pb = new ProcessBuilder("ping", "-c", "3", input);
```
