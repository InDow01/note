# 27. 데이터 평문 전송 (Plaintext Data Transmission / Insufficient Transport Layer Protection)

## 1. 개요 (Overview)
- **정의**: 로그인, 결제, 개인정보 변경 등 민감한 정보를 서버로 전송할 때, 암호화된 통신 채널(HTTPS/SSL)을 사용하지 않고 일반 텍스트(HTTP)로 전송하여 네트워크 상에서 정보가 탈취될 수 있는 취약점.
- **위험도**: **상 (High)** / 계정 탈취 및 개인정보 유출
- **영향**:
    - **스니핑(Sniffing)**: 네트워크 패킷을 감청하여 ID/PW, 주민번호, 신용카드 번호 등을 평문으로 획득.
    - **세션 하이재킹**: 암호화되지 않은 세션 쿠키(JSESSIONID)를 탈취하여 로그인 우회.

> **💡 핵심 원리 (The Postcard vs. The Envelope)**
>
> "HTTP는 엽서와 같다. 우체부(라우터)부터 옆집 사람(해커)까지 내용을 다 볼 수 있다.
> HTTPS는 강철 금고에 담긴 편지다. 내용을 보려면 금고 열쇠(개인키)가 있어야 한다."

---

## 2. 공격 메커니즘 (Attack Vector)

### 시나리오: 공용 와이파이에서의 패킷 감청 (Man-in-the-Middle)
**1. 함정 설치**
- 해커가 스타벅스 같은 곳에서 가짜 와이파이(Starbucks_Free_VIP)를 열거나, 같은 네트워크에 접속해서 `ARP Spoofing`을 시도함.
- 피해자의 모든 통신 패킷이 해커의 노트북을 거쳐서 지나가게 만듦.

**2. 평문 전송**
- 피해자가 `http://ggaera.com` (HTTP)에 접속하여 로그인을 시도.
- 전송 데이터: `POST /login.do`, Body: `id=admin&pw=password123`

**3. 스니핑 (Sniffing)**
- 해커는 **Wireshark** 같은 도구로 패킷을 캡처.
- 암호화가 안 되어 있으므로 `pw=password123`이 글자 그대로 화면에 뜸.
- **결과**: 1초 만에 계정 탈취 완료.

---

## 3. 취약한 설정 vs 안전한 설정 (Tomcat/Spring)

이 취약점은 자바 코드를 고치는 게 아니라, **SSL 인증서를 설치**하고 **HTTPS를 강제**하는 것이 핵심.

### ❌ 취약한 코드 (HTTP 사용)
> `<form>` 태그의 action이 `http://`로 되어 있거나, 서버가 80 포트(HTTP)만 열려있는 경우.

```html
<form action="[http://ggaera.com/login](http://ggaera.com/login)" method="POST">
    ID: <input type="text" name="id">
    PW: <input type="password" name="pw">
    <button>로그인</button>
</form>
```

### ✅ 안전한 설정 1 (Tomcat server.xml - SSL 적용)
>톰캣 설정에서 SSL 인증서(keystore)를 연결하여 443(8443) 포트를 활성화함.

```xml
<Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
           maxThreads="150" SSLEnabled="true">
    <SSLHostConfig>
        <Certificate certificateKeystoreFile="conf/localhost-rsa.jks"
                     type="RSA" x509Algorithm="SHA-256" />
    </SSLHostConfig>
</Connector>
```

### ✅ 안전한 설정 2 (Spring Security - HTTPS 강제)
>사용자가 실수로 http://로 들어와도 무조건 https://로 리다이렉트 시키고, HSTS를 적용함.

```java
// SecurityConfig.java
@Override
protected void configure(HttpSecurity http) throws Exception {
    http
        .requiresChannel()
        .anyRequest().requiresSecure() // 모든 요청에 HTTPS 강제
        .and()
        .headers()
        .httpStrictTransportSecurity() // HSTS 활성화 (브라우저가 알아서 HTTPS로만 접속하게 함)
            .includeSubDomains(true)
            .maxAgeInSeconds(31536000); // 1년 동안 기억
}
```

## 4. 대응 방안 (Remediation Checklist)
1. SSL/TLS 인증서 적용 (Essential):

>웹 서버(Apache/Nginx/Tomcat)에 공인된 인증서(Let's Encrypt 등)를 설치하여 HTTPS 통신을 활성화한다.

로그인, 회원가입, 결제 등 민감 정보가 오가는 페이지는 반드시 암호화 통신을 해야 한다. (요즘은 사이트 전체 적용이 표준이다.)

2. HTTPS 리다이렉트 (Force HTTPS):

>사용자가 http://www.site.com으로 접속하더라도 서버 설정(Rewrite Rule)을 통해 자동으로 https://www.site.com으로 전환되도록 설정한다.

3. Secure Cookie 설정:

>세션 쿠키(JSESSIONID)가 평문(HTTP) 통신으로 노출되지 않도록 Secure 속성을 추가한다.
```xml
설정: cookie.setSecure(true);
```
4. 취약한 암호화 알고리즘 제거:

SSL 설정 시 SSLv2, SSLv3, TLS 1.0 등 구버전 프로토콜은 차단하고, TLS 1.2 또는 TLS 1.3만 허용한다.