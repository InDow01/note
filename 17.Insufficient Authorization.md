# 17. 불충분한 인가 (Insufficient Authorization)

## 1. 개요 (Overview)
- **정의**: 인증된 사용자라도 접근할 자격(권한)이 없는 페이지나 기능에 접근할 수 있도록 통제가 미흡한 취약점.
- **위험도**: **상 (High)** / 권한 상승 및 정보 유출
- **영향**:
    - **수직적 권한 상승**: 일반 사용자가 관리자 메뉴에 접근하여 시스템 설정 변경.
    - **수평적 권한 상승 (IDOR)**: A 사용자가 B 사용자의 게시글을 수정/삭제하거나 개인정보 열람.

> **💡 핵심 원리 (Access Control Matrix)**
>
> "사원증(인증)을 찍고 회사에 들어왔다고 해서, 사장실(관리자 권한)이나 옆 동료의 서랍(타 사용자 데이터)을 마음대로 열 수 있어서는 안 된다."

---

## 2. 공격 메커니즘 (Attack Vector)

### 시나리오 1: URL 강제 접속 (Forced Browsing) - *관리자 페이지*
**1. 관리자 메뉴 접근 시도**
- 일반 사용자로 로그인 후, 관리자 전용 경로를 추측하여 입력.
- 예: `/admin/memberList.do`, `/manager/config`

**2. 권한 검증 부재**
- 서버는 "로그인 여부"만 체크하고, "관리자 여부(Role)"를 체크하지 않음.
- **결과**: 일반 사용자가 관리자 기능을 수행함.

### 시나리오 2: 파라미터 변조 (IDOR) - *데이터 조작*
**1. 정상 요청 분석**
- 사용자가 자신의 게시글을 수정할 때 전송되는 패킷을 프록시(Burp Suite)로 잡음.
- 요청: `POST /board/modify?idx=100` (100번은 내 글)

**2. 파라미터 변조**
- `idx` 파라미터 값을 다른 숫자로 변경하여 전송.
- 조작: `POST /board/modify?idx=101` (101번은 타인의 글)

**3. 소유권 검증 부재**
- 서버는 "글 수정 기능 호출"만 처리하고, "이 글(101번)의 작성자가 현재 요청자(나)와 같은가?"를 확인하지 않음.
- **결과**: 타인의 글이 무단으로 수정/삭제됨.

---

## 3. 취약한 코드 vs 안전한 코드 (Java/Spring)

핵심은 **"페이지 접근 시 권한 체크"**와 **"기능 수행 시 데이터 소유권 체크"** 두 가지를 모두 해야 한다는 점.

### ❌ 취약한 코드 (권한 검증 누락)
> 단순히 로그인 여부(`session != null`)만 검사하고, 관리자(admin)인지 확인 안 함.

```java
// AdminController.java
@RequestMapping("/admin/userList")
public String userList(HttpSession session) {
    // 취약점: 로그인만 되어있으면 누구나 통과
    if (session.getAttribute("userId") == null) {
        return "redirect:/login";
    }
    
    // 관리자 페이지 보여줌 (위험)
    return "admin/userList";
}
```

### ❌ 취약한 코드 (데이터 소유권 검증 누락 - IDOR)
>삭제하려는 게시글 번호(seq)가 넘어오면 무조건 삭제함.
```java
// BoardController.java
@RequestMapping("/board/delete")
public String deleteBoard(@RequestParam String seq) {
    // 취약점: 이 글(seq)을 쓴 사람이 누구인지 확인하지 않고 바로 삭제
    boardService.deleteBoard(seq);
    return "success";
}
```

### ✅ 안전한 코드 1 (Interceptor 활용 - 페이지 접근 제어)
>URL 패턴(/admin/*)에 따라 중앙에서 권한을 검증.

```java
// AdminInterceptor.java
public boolean preHandle(HttpServletRequest req, HttpServletResponse res, Object handler) {
    HttpSession session = req.getSession();
    String userRole = (String) session.getAttribute("userGrade"); // 사용자 등급

    // 1. 로그인 체크
    if (session.getAttribute("userId") == null) return false;

    // 2. 권한(Role) 체크
    if (!"ADMIN".equals(userRole)) {
        res.sendRedirect("/error/no_auth"); // 권한 없음 페이지로 이동
        return false;
    }
    return true;
}
```

### ✅ 안전한 코드 2 (비즈니스 로직 검증 - IDOR 방어)
>DB에서 데이터를 꺼내온 뒤, **작성자(Writer)**와 **요청자(Requester)**가 일치하는지 비교.

```java
// BoardServiceImpl.java
public void deleteBoard(String seq, String currentUserId) {
    // 1. 게시글 정보 조회
    BoardVO board = boardDao.selectBoard(seq);
    
    // 2. 소유권 검증 (작성자와 현재 로그인한 유저 비교)
    if (!board.getWriterId().equals(currentUserId) && !"ADMIN".equals(currentUserId)) {
        throw new AccessDeniedException("삭제 권한이 없습니다.");
    }
    
    // 3. 검증 통과 시 삭제
    boardDao.deleteBoard(seq);
}
```

## 4. 대응 방안 (Remediation Checklist)
1. URL 접근 제어 강화 (Access Control):

- 웹 서버 설정(URI 패턴)이나 프레임워크의 Security 모듈(Interceptor, Filter)을 사용하여 관리자 페이지 등 중요 메뉴에 대한 접근 권한을 화이트리스트 방식으로 통제한다.

2. 서버 사이드 권한 검증:

- 클라이언트(UI)에서 메뉴를 숨기는 것은 보안이 아니다. 반드시 서버에서 요청 시마다 세션 내의 권한 등급을 확인해야 한다.

3. 데이터 소유권 검증 (IDOR 방지):

- 게시글 수정, 삭제, 개인정보 조회 등 특정 데이터에 접근하는 기능 수행 시, 해당 데이터의 소유주와 현재 세션 사용자가 일치하는지 비즈니스 로직 단에서 반드시 검증한다.

4. 무작위 대입 방지:

- 게시글 번호, 주문 번호 등 일련번호(Sequence) 형태의 파라미터를 사용할 경우, 소유권 검증이 필수적이며, 가능한 경우 예측 불가능한 난수(UUID 등)를 식별자로 사용한다.

## 5. 심화 
단순한 URL 접근 제어를 넘어, 최신 웹 환경에서 발생하는 교묘한 권한 우회 기법들을 살펴본다.

1. 매개변수 조작 공격 (Mass Assignment)
많은 프레임워크(Spring, Node.js 등)는 클라이언트가 보낸 JSON 데이터를 객체(Object)에 자동으로 매핑해주는 기능을 제공한다. 이를 악용한 권한 상승 공격이다.

상황: 회원 정보 수정 시 email, nickname만 수정 가능한 폼이 있다.

공격: 해커가 프록시 툴로 요청 패킷에 &role=ADMIN 이나 &point=999999 같은 필드를 몰래 추가해서 보낸다.

결과: 서버의 모델 객체(VO/DTO)에 해당 필드가 존재하고, 별도의 필터링 없이 update(user)를 실행하면 관리자 권한을 획득하거나 포인트를 조작할 수 있다.

대응: 입력받을 데이터 전용 객체(DTO)를 별도로 만들거나, 수정 가능한 필드를 명시적으로 지정해야 한다.

2. HTTP Method 변조 (Method Tampering)
개발자가 특정 HTTP 메소드에 대해서만 보안 규칙을 적용했을 때 발생하는 허점이다.

상황: 보안 설정(web.xml 등)에서 `<limit-method>GET</limit-method>` 태그를 사용하여 GET 요청에 대해서만 관리자 페이지 접근을 막았다.

공격: 해커가 프록시 툴을 이용해 요청 메소드를 GET에서 POST, HEAD, 혹은 PUT 등으로 바꿔서 전송한다.

결과: 서버는 "GET이 아니니까 룰 적용 안 함"이라고 판단하고 요청을 통과시켜 관리자 페이지 내용을 보여줄 수 있다.

대응: 특정 메소드만 막는 것이 아니라, **모든 메소드(*)에 대해 기본적으로 차단(Deny All)**하고 허용할 메소드만 열어두는 방식을 취해야 한다.

3. "순차적 ID"는 초대장이다 (Insecure Direct Object Reference)
취약한 코드 예시에서 본 seq 파라미터처럼 1, 2, 3... 순서대로 증가하는 숫자형 ID는 공격자에게 전체 데이터를 긁어가라는 초대장과 같다.

자동화 공격: 공격자는 'Burp Intruder' 같은 툴을 사용하여 seq=1부터 seq=10000까지 순차적으로 요청을 보내, 데이터 소유권 검증이 누락된 모든 게시글을 수집할 수 있다.

결론: 보안상 중요한 데이터(주문 내역, 개인 프로필 등)의 식별자는 추측 불가능한 UUID를 사용하는 것이 안전하다.